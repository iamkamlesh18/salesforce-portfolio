name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies (with retries)
        run: |
          echo "Node: $(node -v)" && echo "npm: $(npm -v)"
          set -e
          for i in 1 2 3; do
            echo "Attempt $i: npm ci"
            if npm ci --silent; then
              echo "npm ci succeeded"
              break
            else
              echo "npm ci failed on attempt $i"
              if [ "$i" -eq 3 ]; then
                echo "All attempts failed"
                exit 1
              fi
              sleep $((i * 3))
            fi
          done

      - name: Run Prettier (verify)
        run: npm run prettier -- --check

      - name: Run ESLint
        run: npx eslint "**/lwc/**/*.js"

      - name: Run tests with coverage
        run: npm run test:unit:coverage --silent

      - name: Show coverage files (debug)
        run: ls -la coverage || true

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
